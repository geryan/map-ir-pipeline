#' @title
#' @param data
#' @param new_data
#' @param level_zero_model_list
#' @param level_one_model_setup
#' @return
#' @author njtierney
#' @export
inner_loop <- function(data,
                       new_data = NULL,
                       level_zero_models,
                       level_one_model_setup) {

  ir_data_mn_star <- data
  # m_star = Number of rows in each **inner loop** of **genotypic** data
  ir_data_m_star <- ir_data_mn_star %>% filter(type == "genotypic")
  # n_star = Number of rows in each **inner loop** of **phenotypic** data
  ir_data_n_star <- ir_data_mn_star %>% filter(type == "phenotypic")
  # m_star and n_star are generated by the outer loop

  # use the level 0 models to make features for the level 1 stacker training
  # (out of sample, for training)
  oos_covariates <- train_predict_level_zero_model(
    train_predict_data = ir_data_mn_star,
    level_zero_models = level_zero_models
  )

  # use the level 0 models to make features for the level 1 stacker prediction
  # (in sample, for prediction) fit to in_sample_data, and predict to new_data
  in_sample_covariates <- predict_out_of_sample_level_zero_models(
    in_sample_data = ir_data_mn_star,
    level_zero_model_list = level_zero_models,
    new_data = new_data,
    n_insecticides = max(unique(ir_data_mn_star$insecticide_id))
  )

  # Train the level 1 stacker to the out of sample features, and make
  # predictions to the in sample features. For INLA, fitting and prediction must
  # be simultaneous, so do both in this function.
  gp_inla_data_n_star_is_pred <- fit_predict_level_one_model(
    # fit the L1 model to the phenotypic data, using the L0 OOS estimates as
    # covariates
    training_data = ir_data_n_star,
    training_covariates = oos_covariates,
    # predict to the new phenotypic data, using predictions from the in-sample
    # fitted L0 models for the new data
    prediction_data = new_data,
    prediction_covariates = in_sample_covariates,
    # pass in the INLA setup info
    level_one_model_setup = level_one_model_setup
  )

  gp_inla_data_n_star_is_pred

}
