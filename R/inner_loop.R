#' .. content for \description{} (no empty lines) ..
#'
#' .. content for \details{} ..
#'
#' @title
#' @param data
#' @param new_data
#' @param l_zero_model_list
#' @param l_one_model_setup
#' @return
#' @author njtierney
#' @export
inner_loop <- function(data,
                       new_data = NULL,
                       l_zero_model_list,
                       l_one_model_setup) {
  ir_data_mn_star <- data
  # m_star = Number of rows in each **inner loop** of **genotypic** data
  ir_data_m_star <- ir_data_mn_star %>% filter(type == "genotypic")
  # n_star = Number of rows in each **inner loop** of **phenotypic** data
  ir_data_n_star <- ir_data_mn_star %>% filter(type == "phenotypic")
  # m_star and n_star are generated by the outer loop

  # 10 times to get the 10 folds out of sample predictions
  ## The generalisation step
  ## -- Check the generalisation paper for terminolgoy
  # Train on 90% ((N* + M*) x 0.9), predict on 10% (N* x 0.1)

  ## generalisation folds
  ## training and out of sample prediction
  train_predict <- vfold_cv(
    data = ir_data_mn_star,
    v = 10
  )

  # this should be N* + M*
  train_data_mn_star <- extract_training(train_predict)
  # this should just be N*
  predict_data_nstar <- extract_predict(train_predict)

  # this should fit 10 models - preparing for out of sample (oos)
  # currently splitting into two steps as the model takes a long time to fit
  # and we are going to need to have a deeper think about cpu efficiency
  zero_level_oos_mn_star_rf <- fit_zero_level_model(
    data = train_data_mn_star,
    model = l_zero_model_list$rf
  )

  zero_level_oos_mn_star_xgb <- fit_zero_level_model(
    data = train_data_mn_star,
    model = l_zero_model_list$xgb
  )

  # these prediction vectors should happen on each list of `predict_data`
  # these will be of length N*
  # oos = out of sample
  oos_predictions_rf <- predict_model(
    data = predict_data_nstar,
    model = zero_level_oos_mn_star_rf
  )

  oos_predictions_xgb <- predict_model(
    data = predict_data_nstar,
    model = zero_level_oos_mn_star_xgb
  )

  # this should fit 1 model, for in-sample
  # 1 time to the full dataset, fitting to N*+M* data.
  ## NOTE: previously called `fit_zero_level_model`
  zero_level_in_sample_rf <- fit(
    object = l_zero_model_list$rf,
    data = as.data.frame(ir_data_mn_star)
  )

  ## NOTE: previously called `fit_zero_level_model`
  zero_level_in_sample_xgb <- fit(
    object = l_zero_model_list$xgb,
    data = as.data.frame(ir_data_mn_star)
  )

  # ---- the L1 models ---- #
  # Take the out of sample predictions for each of the models,
  # combine them together of length N*, into the fixed effects,
  # one per model (XBG, RF, BGAM)
  # A 3xN* matrix / AKA out of sample covariates?
  oos_covariates <- combine_predictions(list(
    rf = oos_predictions_rf,
    xgb = oos_predictions_xgb
  ))

  # Fit the whole L1 model to N* original data, using out of sample covariates
  gp_inla_data_n_star_oos <- build_inla_data(
    ir_data = ir_data_n_star,
    # including the out of sample covariates
    covariate_data = oos_covariates
  )

  # Fit the whole L1 model to N* original data, using out of sample covariates
  # oos = out of sample
  # super learner = L1 model
  super_learner_oos <- gp_inla(
    data = gp_inla_data_n_star_oos,
    setup = l_one_model_setup
  )


  # Finally, we make a prediction ----
  # Predict to the N* phenotypic data points, to get the in sample predictions
  # We use the predictions generated by this,
  # once we have determined the parameters of the L1 model
  in_sample_covariates <- create_in_sample_covariates(
    workflow_list = list(
      randomForest = zero_level_in_sample_rf,
      xgboost = zero_level_in_sample_xgb
    ),
    data = new_data
  )

  in_sample_covariates_insecticide <- create_insecticide_id_list(
    id = 1:5,
    in_sample_covariates
  )

  ## TODO
  ## L1 model gets fit here with .pred as covariates
  ## AND the original response data as the response
  ## which is the (transformed percent_mortality)
  ## we ONLY do this for phenotypic data for a single insecticide
  ## fit as lm model for now

  # But we switch out-of-sample L0 covariates for L0 **in-sample covariates**
  # that gives a prediction of length N*
  gp_inla_data_n_star_is_pred <- map_dfc(
    .x = in_sample_covariates_insecticide,
    .f = \(x) predict(super_learner_oos,x)
  )

  gp_inla_data_n_star_is <- gp_inla_data_n_star_is_pred %>%
    rename_with(
      .fn = function(x){
        digits <- str_extract(
          names(gp_inla_data_n_star_is_pred),
          "[:digit:]"
          )
        paste0(".pred_insectide_id_",digits)
      }
    )

  return(
    gp_inla_data_n_star_is
  )
}
